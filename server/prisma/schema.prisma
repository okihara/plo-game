generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  avatarUrl     String?
  provider      String    // google, discord, apple
  providerId    String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  nameMasked    Boolean   @default(true)
  useTwitterAvatar Boolean @default(false)

  bankroll      Bankroll?
  statsCache    PlayerStatsCache?
  transactions  Transaction[]
  handHistories HandHistoryPlayer[]

  @@unique([provider, providerId])
  @@index([email])
}

model Bankroll {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(10000) // Starting chips
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Transaction {
  id        String          @id @default(cuid())
  userId    String
  type      TransactionType
  amount    Int
  tableId   String?
  handId    String?
  createdAt DateTime        @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

enum TransactionType {
  DAILY_BONUS
  LOGIN_BONUS
  WIN
  LOSS
  BUY_IN
  CASH_OUT
}

model HandHistory {
  id             String   @id @default(cuid())
  tableId        String
  handNumber     Int
  blinds         String   // e.g., "10/20"
  communityCards String[] // Array of card strings
  potSize        Int
  rakeAmount     Int      @default(0)
  winners        String[] // Array of winner user IDs
  actions        Json     // Full action history
  dealerPosition Int      @default(-1)  // -1 = unknown (legacy data)
  createdAt      DateTime @default(now())

  players HandHistoryPlayer[]

  @@index([tableId])
  @@index([createdAt])
}

model HandHistoryPlayer {
  id            String  @id @default(cuid())
  handHistoryId String
  userId        String?
  username      String  @default("")
  seatPosition  Int
  holeCards     String[] // Array of card strings
  finalHand     String?  // e.g., "Full House, Aces full of Kings"
  profit        Int      // Can be negative for losses
  allInEVProfit Int?     // EV-based profit for all-in runouts (null = not all-in hand)

  handHistory HandHistory @relation(fields: [handHistoryId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([handHistoryId])
}

model PlayerStatsCache {
  id                   String   @id @default(cuid())
  userId               String   @unique
  handsPlayed          Int      @default(0)
  winCount             Int      @default(0)
  totalProfit          Int      @default(0)
  detailedHands        Int      @default(0)
  vpipCount            Int      @default(0)
  pfrCount             Int      @default(0)
  threeBetCount        Int      @default(0)
  threeBetOpportunity  Int      @default(0)
  foldTo3BetCount      Int      @default(0)
  faced3BetCount       Int      @default(0)
  fourBetCount         Int      @default(0)
  fourBetOpportunity   Int      @default(0)
  aggressiveActions    Int      @default(0)
  totalPostflopActions Int      @default(0)
  cbetCount            Int      @default(0)
  cbetOpportunity      Int      @default(0)
  foldToCbetCount      Int      @default(0)
  facedCbetCount       Int      @default(0)
  sawFlopCount         Int      @default(0)
  wtsdCount            Int      @default(0)
  wsdCount             Int      @default(0)
  totalAllInEVProfit   Int      @default(0)
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DailyBonus {
  id        String   @id @default(cuid())
  odId   String   @unique
  claimedAt DateTime @default(now())

  @@index([odId, claimedAt])
}

model MaintenanceMode {
  id          String    @id @default("singleton")
  isActive    Boolean   @default(false)
  message     String    @default("")
  activatedAt DateTime?
  updatedAt   DateTime  @updatedAt
}
