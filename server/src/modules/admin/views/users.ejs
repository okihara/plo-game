<!DOCTYPE html>
<html lang="ja">
<head>
  <%- include('_head', { title: 'PLO Users' }) %>
  <style>
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-input {
      padding: 6px 10px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 13px;
      width: 260px;
    }
    .search-input::placeholder { color: #64748b; }
    .summary { font-size: 12px; color: #94a3b8; margin-left: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e293b;
      border-radius: 8px;
      overflow: hidden;
    }
    thead th {
      padding: 8px 12px;
      text-align: left;
      font-size: 11px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #334155;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    thead th:hover { color: #e2e8f0; }
    thead th.sorted { color: #60a5fa; }
    thead th .arrow { margin-left: 4px; font-size: 9px; }
    tbody tr { border-bottom: 1px solid #1e293b; transition: background 0.15s; }
    tbody tr:hover { background: #334155; }
    tbody td { padding: 6px 12px; font-size: 12px; white-space: nowrap; }
    .avatar { width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 6px; }
    .username { font-weight: 600; }
    .provider-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 9999px;
      font-weight: 500;
      background: #334155;
      color: #94a3b8;
    }
    .provider-badge.twitter { background: #1d4ed8; color: white; }
    .chips { color: #fbbf24; font-weight: 600; }
    .hands { color: #a78bfa; }
    .date { color: #64748b; }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    .pagination button {
      padding: 4px 12px;
      background: #334155;
      border: none;
      border-radius: 6px;
      color: #e2e8f0;
      cursor: pointer;
      font-size: 12px;
    }
    .pagination button:hover:not(:disabled) { background: #475569; }
    .pagination button:disabled { opacity: 0.3; cursor: default; }
    .pagination .page-info { font-size: 12px; color: #94a3b8; }
    .loading { text-align: center; padding: 30px; color: #64748b; }
    .nav { margin-bottom: 10px; }
    .filter-group { display: flex; gap: 2px; }
    .filter-btn {
      padding: 5px 12px;
      background: #334155;
      border: 1px solid #475569;
      color: #94a3b8;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .filter-btn:first-child { border-radius: 6px 0 0 6px; }
    .filter-btn:last-child { border-radius: 0 6px 6px 0; }
    .filter-btn:hover { background: #475569; color: #e2e8f0; }
    .filter-btn.active { background: #3b82f6; border-color: #3b82f6; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <%- include('_nav', { current: 'users' }) %>
    <h1>ユーザー一覧</h1>

    <div class="toolbar">
      <input type="text" class="search-input" id="searchInput" placeholder="ユーザー名 / メールで検索...">
      <div class="filter-group">
        <button class="filter-btn active" data-filter="all">全て</button>
        <button class="filter-btn" data-filter="human">人間</button>
        <button class="filter-btn" data-filter="bot">Bot</button>
      </div>
      <div class="summary" id="summary"></div>
    </div>

    <table>
      <thead>
        <tr>
          <th data-sort="username">ユーザー名 <span class="arrow"></span></th>
          <th data-sort="email">メール <span class="arrow"></span></th>
          <th data-sort="provider">認証 <span class="arrow"></span></th>
          <th data-sort="balance">チップ <span class="arrow"></span></th>
          <th data-sort="handsPlayed">ハンド数 <span class="arrow"></span></th>
          <th data-sort="lastLoginAt">最終ログイン <span class="arrow"></span></th>
          <th data-sort="createdAt">登録日 <span class="arrow"></span></th>
        </tr>
      </thead>
      <tbody id="usersBody">
        <tr><td colspan="7" class="loading">読み込み中...</td></tr>
      </tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </div>

  <script>
    var currentPage = 1, currentSort = 'createdAt', currentOrder = 'desc', currentFilter = 'all', searchTimeout = null;
    function formatDate(iso) {
      if (!iso) return '-';
      var d = new Date(iso);
      return d.toLocaleDateString('ja-JP') + ' ' + d.toLocaleTimeString('ja-JP', { hour:'2-digit', minute:'2-digit' });
    }
    function formatChips(n) { return '$' + n.toLocaleString(); }
    function escapeHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    async function fetchUsers() {
      var search = document.getElementById('searchInput').value;
      var url = '/api/admin/users?page=' + currentPage + '&sort=' + currentSort + '&order=' + currentOrder +
        '&filter=' + currentFilter +
        (search ? '&search=' + encodeURIComponent(search) : '');
      try {
        var res = await fetch(apiUrl(url));
        var data = await res.json();
        renderUsers(data);
      } catch (e) {
        document.getElementById('usersBody').innerHTML = '<tr><td colspan="7" class="loading" style="color:#ef4444">読み込みエラー</td></tr>';
      }
    }

    function renderUsers(data) {
      document.getElementById('summary').textContent =
        data.total + '人中 ' + ((data.page-1)*data.limit+1) + '-' + Math.min(data.page*data.limit, data.total) + '人表示';

      var html = data.users.map(function(u) {
        var avatar = u.avatarUrl ? '<img class="avatar" src="' + u.avatarUrl + '" alt="">' : '';
        var pCls = u.provider === 'twitter' ? ' twitter' : '';
        return '<tr>' +
          '<td>' + avatar + '<span class="username">' + escapeHtml(u.username) + '</span></td>' +
          '<td>' + escapeHtml(u.email) + '</td>' +
          '<td><span class="provider-badge' + pCls + '">' + u.provider + '</span></td>' +
          '<td class="chips">' + formatChips(u.balance) + '</td>' +
          '<td class="hands">' + u.handsPlayed.toLocaleString() + '</td>' +
          '<td class="date">' + formatDate(u.lastLoginAt) + '</td>' +
          '<td class="date">' + formatDate(u.createdAt) + '</td>' +
        '</tr>';
      }).join('');

      if (!data.users.length) html = '<tr><td colspan="7" class="loading">該当ユーザーなし</td></tr>';
      document.getElementById('usersBody').innerHTML = html;

      document.getElementById('pagination').innerHTML =
        '<button ' + (data.page<=1?'disabled':'') + ' onclick="goPage(' + (data.page-1) + ')">前へ</button>' +
        '<span class="page-info">' + data.page + ' / ' + data.totalPages + '</span>' +
        '<button ' + (data.page>=data.totalPages?'disabled':'') + ' onclick="goPage(' + (data.page+1) + ')">次へ</button>';

      document.querySelectorAll('thead th[data-sort]').forEach(function(th) {
        var s = th.getAttribute('data-sort');
        th.classList.toggle('sorted', s === currentSort);
        th.querySelector('.arrow').textContent = s === currentSort ? (currentOrder === 'asc' ? '▲' : '▼') : '';
      });
    }

    function goPage(p) { currentPage = p; fetchUsers(); }

    document.querySelectorAll('thead th[data-sort]').forEach(function(th) {
      th.addEventListener('click', function() {
        var s = th.getAttribute('data-sort');
        if (currentSort === s) { currentOrder = currentOrder === 'desc' ? 'asc' : 'desc'; }
        else { currentSort = s; currentOrder = 'desc'; }
        currentPage = 1;
        fetchUsers();
      });
    });

    document.getElementById('searchInput').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(function() { currentPage = 1; fetchUsers(); }, 300);
    });

    document.querySelectorAll('.filter-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        currentFilter = btn.getAttribute('data-filter');
        document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentPage = 1;
        fetchUsers();
      });
    });

    fetchUsers();
  </script>
</body>
</html>
