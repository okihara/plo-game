<!DOCTYPE html>
<html lang="ja">
<head>
  <%- include('_head', { title: 'PLO Connected Players' }) %>
  <style>
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .summary { font-size: 12px; color: #94a3b8; display: flex; gap: 14px; }
    .summary-item { display: flex; align-items: center; gap: 4px; }
    .summary-count { font-weight: 700; color: #f8fafc; font-size: 14px; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e293b;
      border-radius: 8px;
      overflow: hidden;
    }
    thead th {
      padding: 8px 12px;
      text-align: left;
      font-size: 11px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #334155;
      white-space: nowrap;
    }
    tbody tr { border-bottom: 1px solid #1e293b; transition: background 0.15s; }
    tbody tr:hover { background: #334155; }
    tbody td { padding: 6px 12px; font-size: 12px; white-space: nowrap; }
    .avatar { width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 6px; }
    .username { font-weight: 600; }
    .provider-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 9999px;
      font-weight: 500;
      background: #334155;
      color: #94a3b8;
    }
    .provider-badge.twitter { background: #1d4ed8; color: white; }
    .provider-badge.bot { background: #7c3aed; color: white; }
    .chips { color: #fbbf24; font-weight: 600; }
    .balance { color: #a78bfa; }
    .table-link { color: #60a5fa; font-size: 11px; }
    .seat-info { color: #94a3b8; font-size: 11px; }
    .status-idle { color: #64748b; }
    .nav { margin-bottom: 10px; }
    .refresh-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #64748b;
      font-size: 11px;
      margin-top: 10px;
    }
    .refresh-bar select {
      background: #1e293b;
      color: #e2e8f0;
      border: 1px solid #334155;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .loading { text-align: center; padding: 30px; color: #64748b; }
  </style>
</head>
<body>
  <div class="container">
    <%- include('_nav', { current: 'players' }) %>
    <h1>
      <div class="status-dot" id="statusDot"></div>
      接続中プレイヤー
      <span style="font-size:11px;color:#64748b;margin-left:auto" id="lastUpdate"></span>
    </h1>

    <div class="toolbar">
      <div class="summary" id="summary"></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>プレイヤー</th>
          <th>表示名</th>
          <th>種別</th>
          <th>バランス</th>
          <th>テーブル</th>
          <th>席</th>
          <th>チップ</th>
        </tr>
      </thead>
      <tbody id="playersBody">
        <tr><td colspan="7" class="loading">読み込み中...</td></tr>
      </tbody>
    </table>

    <div class="refresh-bar">
      <span>自動更新:</span>
      <select id="refreshInterval" onchange="changeInterval(this.value)">
        <option value="2000">2秒</option>
        <option value="5000" selected>5秒</option>
        <option value="10000">10秒</option>
        <option value="0">停止</option>
      </select>
    </div>
  </div>

  <script>
    function formatChips(n) { return '$' + n.toLocaleString(); }
    function escapeHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    async function fetchPlayers() {
      try {
        var res = await fetch(apiUrl('/api/admin/players'));
        var data = await res.json();
        renderPlayers(data);
        document.getElementById('statusDot').classList.remove('error');
      } catch (e) {
        console.error('Failed to fetch players:', e);
        document.getElementById('statusDot').classList.add('error');
      }
    }

    function renderPlayers(data) {
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ja-JP');

      document.getElementById('summary').innerHTML =
        '<div class="summary-item">合計 <span class="summary-count">' + data.total + '</span></div>' +
        '<div class="summary-item">人間 <span class="summary-count">' + data.humans + '</span></div>' +
        '<div class="summary-item">Bot <span class="summary-count">' + data.bots + '</span></div>' +
        '<div class="summary-item">着席中 <span class="summary-count">' + data.seated + '</span></div>';

      if (!data.players.length) {
        document.getElementById('playersBody').innerHTML =
          '<tr><td colspan="7" class="loading">接続中のプレイヤーなし</td></tr>';
        return;
      }

      var html = data.players.map(function(p) {
        var avatar = p.avatarUrl ? '<img class="avatar" src="' + p.avatarUrl + '" alt="">' : '';
        var pCls = p.isBot ? ' bot' : (p.provider === 'twitter' ? ' twitter' : '');
        var providerLabel = p.isBot ? 'bot' : p.provider;

        var tableCell = p.tableId
          ? '<span class="table-link">' + p.tableBlinds + ' <span style="color:#64748b;font-size:10px">(' + p.tableId.slice(0, 8) + ')</span></span>'
          : '<span class="status-idle">-</span>';

        var seatCell = p.seatNumber !== null
          ? '<span class="seat-info">Seat ' + (p.seatNumber + 1) + '</span>'
          : '<span class="status-idle">-</span>';

        var chipsCell = p.chips !== null
          ? '<span class="chips">' + formatChips(p.chips) + '</span>'
          : '<span class="status-idle">-</span>';

        return '<tr>' +
          '<td>' + avatar + '<span class="username">' + escapeHtml(p.username) + '</span></td>' +
          '<td>' + (p.displayName ? escapeHtml(p.displayName) : '<span style="color:#64748b">-</span>') + '</td>' +
          '<td><span class="provider-badge' + pCls + '">' + providerLabel + '</span></td>' +
          '<td class="balance">' + formatChips(p.balance) + '</td>' +
          '<td>' + tableCell + '</td>' +
          '<td>' + seatCell + '</td>' +
          '<td>' + chipsCell + '</td>' +
        '</tr>';
      }).join('');

      document.getElementById('playersBody').innerHTML = html;
    }

    var intervalId = null;
    function changeInterval(ms) {
      if (intervalId) clearInterval(intervalId);
      intervalId = null;
      ms = parseInt(ms, 10);
      if (ms > 0) intervalId = setInterval(fetchPlayers, ms);
    }
    fetchPlayers();
    changeInterval(5000);
  </script>
</body>
</html>
