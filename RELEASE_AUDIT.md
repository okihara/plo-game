# PLO ポーカーゲーム リリース準備状況レポート

**監査日:** 2026-02-07
**結論: リリースには未到達。CRITICAL/HIGH の修正が必要。**

---

## 総合評価

| カテゴリ | 評価 | 備考 |
|---------|------|------|
| ビルド | PASS | フロントエンド・サーバーともにビルド成功 |
| ゲームロジック | **FAIL** | サイドポット未実装、複数の致命的バグ |
| セキュリティ | **FAIL** | Bot認証バイパス、管理画面無認証、入力検証不足 |
| マルチプレイヤー | **FAIL** | チップ消失、再接続未対応、残高レースコンディション |
| デプロイ設定 | WARN | `prisma db push`は本番非推奨 |
| UI/UX | WARN | トースト通知なし、アクセシビリティ不足 |
| テスト | **FAIL** | テストコードが一切存在しない |

---

## CRITICAL（致命的 — リリース不可）

### 1. サイドポットが未実装

**ファイル:** `server/src/shared/logic/gameEngine.ts:582-590`, `types.ts:44`

`sidePots` フィールドは型定義に存在するが、一度も計算されない。`determineWinner` はポット全体を勝者で均等分割するのみ。

**再現シナリオ:**
- プレイヤーA: 100チップでオールイン
- プレイヤーB: 500チップでレイズ300
- プレイヤーC: コール300
- ポット合計: 700
- プレイヤーAが最強ハンド

**正しい結果:** A → 300（メインポット100×3）、残り400はB/Cの強い方へ
**現在の結果:** A → 700全額。直接的な金額計算エラー。

### 2. Bot認証バイパス — 誰でもBotになりすまし可能

**ファイル:** `server/src/modules/game/socket.ts:32-45`

WebSocket接続時に `isBot: true` を送信するだけで、JWT認証をスキップし、バランスチェックなしでテーブルに参加できる。攻撃者は無制限に無料チップでプレイ可能。

### 3. 管理画面が完全に無認証

**ファイル:** `server/src/modules/admin/routes.ts`

`/admin/status` と `/api/admin/stats` に認証なし。全テーブル状態、プレイヤーID、メモリ使用量が公開される。プレイヤー名がHTML直接挿入されるためXSS脆弱性もある。

### 4. 残高操作のレースコンディション

**ファイル:** `server/src/modules/game/socket.ts:99-155`

`table:join` のバランスチェックとデクリメントが非アトミック（TOCTOU）。2つのタブから同時にバイインすると残高がマイナスになる可能性。

### 5. テーブル退出時にチップが消失

**ファイル:** `server/src/modules/game/socket.ts:163-173`

`table:leave` ハンドラがチップをバンクロールに返却しない。コメントにも「TODO」と記載。切断時の30秒タイムアウト後も同様にチップが永久消失。

---

## HIGH（重大 — リリース前に修正すべき）

### 6. ヘッズアップでブラインドオールイン時にゲームフリーズ

**ファイル:** `server/src/shared/logic/gameEngine.ts:143-148`

SBがちょうどSB額しか持っていない場合、ブラインド投稿後にオールインとなるが、そのプレイヤーがcurrentPlayerIndexに設定される。`getValidActions` は空配列を返し、タイムアウトのfoldも検証失敗でゲームが永久停止。

### 7. ショートオールインがアクションを再オープンする

**ファイル:** `server/src/shared/logic/gameEngine.ts:342-366`

ミニマムレイズ未満のオールインでも `currentBet` が更新され、既にアクション済みのプレイヤーが再度アクション可能になる。ポーカールール違反（ショートオールインはアクションを再オープンしない）。

### 8. Socketイベントの入力検証が一切ない

**ファイル:** `server/src/modules/game/socket.ts` 全体

`buyIn: -1000`（負数）を送信するとPrismaの `decrement` が `increment` として動作し、無料チップを獲得可能。全SocketイベントにZodバリデーションが必要。

### 9. レート制限なし

HTTPエンドポイント・Socketイベントともにレート制限がない。デイリーボーナスの連打、アクションのフラッド、管理画面のDoSが可能。

### 10. カードシャッフルに `Math.random()` を使用

**ファイル:** `server/src/shared/logic/deck.ts:16-23`

`Math.random()` は予測可能なPRNG。ポーカーゲームでは `crypto.randomInt()` を使用すべき。

### 11. 再接続サポートなし

クライアント側に自動再接続ロジックがない。サーバーには30秒の猶予があるが、クライアントは再接続を試みない。再接続してもシートの再取得ができない。

### 12. DailyBonusスキーマのバグ

**ファイル:** `server/prisma/schema.prisma:97`

`odId` に `@unique` 制約があるため、ユーザーごとに1レコードしか作成できない。2日目以降のデイリーボーナスがunique制約違反で失敗する。

---

## MEDIUM（中程度 — リリース後早期に対応）

| # | 問題 | ファイル |
|---|------|---------|
| 13 | バスト済みプレイヤー（0チップ）がアクション対象になる | gameEngine.ts:73-81 |
| 14 | オンラインモードで直接状態変更がエンジンをバイパス | TableInstance.ts:185-208 |
| 15 | ストリート遷移タイマーがハンド完了後に発火する可能性 | TableInstance.ts:296-304 |
| 16 | CPU AIがダミーカードで不完全ボードを評価 | cpuAI.ts:462-465 |
| 17 | `prisma db push` が本番デプロイで使用されている | railway.toml |
| 18 | ヘルスチェックがDB接続を確認しない | index.ts:44 |
| 19 | トースト/通知システムなし | フロントエンド全体 |
| 20 | デバッグページが本番でアクセス可能 | `/debug/player` |
| 21 | ロビーのプレイヤー数がハードコード | SimpleLobby.tsx:16 |
| 22 | サーバーTSがビルド時にコンパイルされない | tsx実行時コンパイル |
| 23 | Fastifyに低レベルDoS脆弱性 | fastify <=5.7.2 (GHSA-mrq3-vjjr-p77c) |

---

## LOW（軽微 — 改善推奨）

| # | 問題 |
|---|------|
| 24 | ロイヤルフラッシュの表示名が「ストレートフラッシュ」 |
| 25 | `lastRaiserIndex` がデッドコード |
| 26 | エクイティ計算のシャッフルが偏りのある `Array.sort()` |
| 27 | バーンカードなし（公平性に影響なし、規制準拠の問題） |
| 28 | server/に console.log が47箇所以上 |
| 29 | フロント/サーバーでゲームロジックが重複管理 |
| 30 | JWTの有効期限7日、失効機構なし |

---

## ビルド検証結果

```
フロントエンド (tsc + vite build): PASS ✓
  78モジュール変換、dist出力成功
  index.js: 241KB (gzip: 75KB)

サーバー (prisma generate): PASS ✓
  Prisma Client v6.19.2 生成成功

脆弱性:
  フロントエンド: 0件
  サーバー: 1件 (low - Fastify DoS, npm audit fixで修正可)
```

---

## リリースまでのロードマップ（推奨優先順位）

### Phase 1: ブロッカー修正（リリース必須）
1. サイドポット計算の実装
2. Bot認証にシークレット追加 or localhost制限
3. 管理画面に認証追加
4. Socket入力のZodバリデーション追加（特に `buyIn` の正数チェック）
5. バランス操作をPrismaトランザクション化
6. テーブル退出・切断時のチップ返却実装
7. DailyBonusスキーマの `@unique` 削除

### Phase 2: 重要修正
8. ヘッズアップ・ブラインドオールイン時のフリーズ修正
9. ショートオールインのアクション再オープン修正
10. `crypto.randomInt()` によるカードシャッフル
11. クライアント自動再接続とシート再取得
12. レート制限の追加
13. `prisma migrate deploy` への移行

### Phase 3: 品質向上
14. テストスイートの構築（最低限: handEvaluator, gameEngine, サイドポット）
15. 構造化ログへの移行（Pino）
16. ヘルスチェックにDB接続確認追加
17. トースト通知システム追加
18. Fastifyバージョン更新

---

## 結論

コードベースの構造とアーキテクチャは良好で、PLOの基本ルール（2+3ルール、ハンドランキング、ポットリミット計算）は正しく実装されている。しかし、**サイドポット未実装**、**セキュリティ上の重大な穴**（Bot認証バイパス、無認証管理画面、入力検証不足）、**チップ消失バグ**が存在し、現時点ではリリースに耐えられない。

Phase 1の修正完了後、限定的なベータリリースは可能と判断する。
